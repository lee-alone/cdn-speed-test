# 配置保存问题解决方案

## 问题描述
前端点击"保存配置"按钮时出现保存失败的警告。

## 问题原因
1. **配置结构不匹配**：前端发送的配置格式与后端期望的 `yamlconfig.Config` 结构不完全一致
2. **字段名称错误**：一些字段名称在前后端之间不匹配
3. **缺少必要字段**：前端没有发送所有后端需要的字段

## 解决方案

### 1. 修复了前端配置结构
- 修正了字段名称映射（如 `max_retries` → `retry_attempts`）
- 添加了所有必需的字段
- 确保配置结构与后端 `yamlconfig.Config` 完全匹配

### 2. 改进了错误处理
- 添加了详细的错误日志
- 改进了前端错误显示
- 添加了配置验证功能

### 3. 新增功能
- **验证配置**按钮：在保存前验证配置是否正确
- **调试信息**按钮：查看详细的系统状态
- 更好的错误提示信息

## 使用方法

### 1. 验证配置
在保存配置前，先点击绿色的"验证配置"按钮：
- ✓ 如果显示"配置验证通过"，可以安全保存
- ✗ 如果显示验证失败，请根据错误信息修正配置

### 2. 保存配置
点击"保存配置"按钮：
- 成功：显示"配置已保存"
- 失败：显示具体的错误信息

### 3. 调试问题
如果仍有问题，可以：
1. 点击红色的"调试信息"按钮查看系统状态
2. 运行 `test_config.bat` 脚本测试配置API
3. 查看浏览器控制台的详细日志

## 配置字段说明

### 测试配置 (test)
- `expected_servers`: 期望服务数 (1-100)
- `use_tls`: 是否使用TLS
- `ip_type`: IP类型 ("ipv4" 或 "ipv6")
- `bandwidth`: 期望带宽 (0.1-10000 Mbps)
- `timeout`: 超时时间 (1-300秒)
- `download_time`: 下载时间 (1-300秒)

### 高级配置 (advanced)
- `concurrent_workers`: 并发工作线程 (1-100)
- `retry_attempts`: 重试次数 (0-10)
- `enable_metrics`: 是否启用性能监控

### UI配置 (ui)
- `datacenter_filter`: 数据中心筛选模式 ("all" 或 "selected")
- `result_format`: 结果格式 ("table", "json", "csv")
- `theme`: 主题 ("light", "dark", "auto")

## 故障排除

### 常见错误及解决方法

1. **"Invalid JSON format"**
   - 检查配置值是否有效（数字、布尔值等）
   - 确保所有必填字段都有值

2. **"Configuration validation failed"**
   - 检查数值范围是否在有效范围内
   - 确保字符串字段使用正确的值

3. **"Failed to save config to file"**
   - 检查程序是否有写入权限
   - 确保配置目录存在

### 测试步骤

1. 启动程序
2. 打开浏览器访问 http://localhost:8081
3. 修改配置
4. 点击"验证配置"
5. 如果验证通过，点击"保存配置"

### 命令行测试

运行 `test_config.bat` 脚本可以测试配置API是否正常工作：

```bash
test_config.bat
```

这个脚本会：
1. 检查程序是否运行
2. 获取当前配置
3. 测试配置验证
4. 测试配置更新
5. 测试配置保存

## 注意事项

1. 配置保存后会立即生效
2. 建议在修改配置前备份原配置文件
3. 如果配置损坏，程序会自动创建默认配置
4. 数据中心筛选设置会影响测试结果

## 技术细节

### 配置文件位置
- 配置文件：`config.yaml`（与程序同目录）
- 示例配置：`config.yaml.example`

### API端点
- `GET /api/config` - 获取当前配置
- `POST /api/config` - 更新内存中的配置
- `POST /api/config/save` - 保存配置到文件
- `POST /api/config/validate` - 验证配置
- `GET /api/debug` - 获取调试信息