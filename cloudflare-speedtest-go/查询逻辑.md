# IP测速后端逻辑流程

## 整体架构
这是一个Cloudflare IP优选测速系统，通过测试不同的Cloudflare IP节点，找到满足带宽要求的最优IP。

---

## 核心流程

### 1. 初始化阶段
- 读取配置参数：期望带宽、超时时间、下载时间、IP类型（IPv4/IPv6）
- 加载IP子网列表（从配置文件）
- 初始化IP生成器用于生成随机IP
- 初始化已测试IP集合（用于去重）

### 2. 循环测试阶段（持续循环直到找到足够的合格IP）

#### 第一步：IP生成与预筛选
- 从IP子网列表中随机选择多个子网
- 为每个子网生成随机IP
- 生成候选IP池

#### 第二步：数据中心检测
对每个候选IP执行：
- 发送HTTP/HTTPS请求到 `/cdn-cgi/trace` 端点
- 解析响应获取数据中心代码
- 同时测量延迟（往返时间）
- 根据用户选择的数据中心进行筛选：
  - 如果选择"全部"，保留所有有效IP
  - 如果选择特定数据中心，只保留匹配的IP

#### 第三步：速度测试
对筛选后的IP执行：
- 下载指定文件，持续时间由配置参数控制
- 实时计算速度：
  - 定期采样当前速度
  - 使用滑动窗口计算平均速度
  - 记录峰值速度
- 最终计算平均速度（单位：Mbps）

### 3. 结果筛选与保存
- 检查是否已找到足够数量的合格IP（速度 ≥ 期望带宽）
- 当找到足够的合格IP时：
  - 将结果写入输出文件
  - 记录时间戳、IP、延迟、平均速度、峰值速度、数据中心信息
  - 检查IP是否已存在（避免重复）

---

## 关键模块说明

| 模块 | 功能 |
|------|------|
| **IPGenerator** | 根据子网生成随机IP，维护已生成IP集合避免重复 |
| **SpeedTester** | 执行延迟测试和速度测试，支持HTTP/HTTPS协议 |
| **FileDownloader** | 下载和管理配置文件（IP列表、数据中心映射等） |
| **ConfigManager** | 管理配置参数的读写 |
| **ResultWriter** | 将测试结果写入文件，支持数据中心名称映射 |
| **NetworkTester** | 检测网络环境状态 |

---

## 数据流向

```
用户配置 → 生成随机IP → 检测数据中心 → 筛选匹配IP → 速度测试 → 结果保存
                                                    ↓
                                        找到足够合格IP? → 是 → 保存并结束
                                                    ↓
                                                   否 → 继续循环
```

---

## 关键参数

- **期望带宽**：筛选条件，只保存速度≥此值的IP
- **超时时间**：单个IP测试的超时限制
- **下载时间**：速度测试的持续时间
- **期待服务数**：需要找到的合格IP数量
- **数据中心**：可选的地理位置筛选条件
- **IP类型**：IPv4或IPv6

---

## 详细流程图

### 主测试循环流程

```
开始测试
  ↓
读取配置参数和IP子网列表
  ↓
[主循环] 检查是否找到足够合格IP?
  ├─ 是 → 保存结果 → 显示完成提示 → 结束
  └─ 否 ↓
    随机选择子网集合
      ↓
    为每个子网生成随机IP
      ↓
    [IP循环] 对每个候选IP执行：
      ├─ 发送请求到 /cdn-cgi/trace
      ├─ 获取数据中心代码
      ├─ 检查数据中心是否匹配用户选择
      ├─ 匹配 → 标记为"待测试"
      └─ 不匹配 → 标记为"跳过"
      ↓
    [测试循环] 对每个待测试IP执行：
      ├─ 下载文件（持续指定时间）
      ├─ 实时计算速度（定期采样）
      ├─ 记录峰值速度
      ├─ 计算平均速度
      └─ 标记为"已完成"
      ↓
    返回主循环
```

---

## 速度计算详解

### 延迟测试
- 发送请求到 `/cdn-cgi/trace` 端点
- 测量往返时间（RTT）
- 单位：毫秒（ms）

### 速度测试
1. **采样阶段**（定期采样）
   - 计算当前速度 = 已下载字节数 / 已耗时
   - 转换为Mbps单位
   - 添加到样本队列

2. **滑动窗口计算**
   - 维护最近N个样本
   - 计算窗口内平均速度
   - 更新峰值速度

3. **最终结果**
   - 平均速度 = 总下载字节数 / 总耗时
   - 单位：Mbps

---

## 配置文件依赖

| 文件 | 用途 |
|------|------|
| IP子网列表 | IPv4/IPv6子网集合 |
| 数据中心映射 | 数据中心代码与地理位置的对应关系 |
| 测速文件URL | 用于测速的文件下载地址 |
| 配置文件 | 用户配置参数保存 |

---

## 核心算法特点

1. **随机采样**：从大量子网中随机选择，提高效率
2. **两阶段筛选**：先按数据中心筛选，再按速度筛选
3. **实时反馈**：实时显示当前速度和峰值速度
4. **智能停止**：找到足够合格IP后立即停止
5. **去重机制**：避免重复测试相同IP
6. **滑动窗口**：平滑速度波动，准确反映网络状况
7. **并发控制**：可支持并发测试多个IP以提高效率
